name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.0.1)"
        required: true
      skip_publish:
        description: "Skip binary publish"
        required: false
        default: "false"
      skip_docker:
        description: "Skip docker publish"
        required: false
        default: "false"
      skip_homebrew:
        description: "Skip homebrew publish"
        required: false
        default: "false"
      skip_validate:
        description: "Skip GoReleaser validation"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Checkout release tag
        run: |
          git fetch --tags
          TAG="${{ github.event.release.tag_name || github.event.inputs.tag }}"
          if [ -z "$TAG" ]; then
            echo "Error: No tag provided in release event or workflow_dispatch input"
            exit 1
          fi
          echo "Checking out tag $TAG"
          git checkout "$TAG"

      - name: Set up Go (from go.mod)
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      # Setup QEMU, buildx and login to DockerHub, required for GoReleaser
      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Login to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: latest
          args: >
            release --clean
            ${{ github.event.inputs.skip_publish == 'true' && ' --skip publish' || '' }}
            ${{ github.event.inputs.skip_validate == 'true' && ' --skip validate' || '' }}
            ${{ github.event.inputs.skip_docker == 'true' && ' --skip docker' || '' }}
            ${{ github.event.inputs.skip_homebrew == 'true' && ' --skip homebrew' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}